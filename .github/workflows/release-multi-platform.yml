name: Multi-Platform Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Build Rust binaries for all platforms
  build-native:
    name: Build Native Binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x64

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: darwin-x64

          # macOS ARM64 (M1/M2/M3)
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-arm64

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: win32-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.target }}

      # Build CLI binary
      - name: Build HoloScript CLI
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: packages/cli
        if: hashFiles('packages/cli/Cargo.toml') != ''

      # TODO: Code signing step (placeholder)
      # - name: Sign binary (macOS)
      #   if: runner.os == 'macOS'
      #   run: |
      #     codesign --sign "Developer ID Application" target/${{ matrix.target }}/release/holoscript
      #     xcrun notarytool submit ...

      # - name: Sign binary (Windows)
      #   if: runner.os == 'Windows'
      #   run: |
      #     signtool sign /f cert.pfx /p ${{ secrets.CERT_PASSWORD }} target/${{ matrix.target }}/release/holoscript.exe

      # Upload binaries as artifacts
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: holoscript-${{ matrix.platform }}
          path: |
            packages/cli/target/${{ matrix.target }}/release/holoscript${{ runner.os == 'Windows' && '.exe' || '' }}
          retention-days: 7

  # Job 2: Build WASM packages
  build-wasm:
    name: Build WASM Packages
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      # Use pre-built wasm-pack (faster than cargo install)
      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      # Build compiler-wasm
      - name: Build compiler-wasm
        run: wasm-pack build --target bundler --scope holoscript
        working-directory: packages/compiler-wasm

      # Build holoscript-component
      - name: Build holoscript-component
        run: wasm-pack build --target bundler --scope holoscript
        working-directory: packages/holoscript-component

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-packages
          path: |
            packages/compiler-wasm/pkg
            packages/holoscript-component/pkg
          retention-days: 7

  # Job 3: Publish to Cargo (BEFORE npm)
  publish-cargo:
    name: Publish to crates.io
    needs: [build-native, build-wasm]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      # CRITICAL: Publish Cargo first (G.003.01)
      - name: Publish holoscript-wasm to crates.io
        run: cargo publish --token ${{ secrets.CARGO_TOKEN }} --allow-dirty
        working-directory: packages/compiler-wasm
        continue-on-error: true  # May already be published

      - name: Wait for crates.io indexing
        run: sleep 30

      - name: Publish holoscript-component to crates.io
        run: cargo publish --token ${{ secrets.CARGO_TOKEN }} --allow-dirty
        working-directory: packages/holoscript-component
        continue-on-error: true

  # Job 4: Test on all platforms
  test-multi-platform:
    name: Test on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [20.x]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Build packages
        run: pnpm build

      - name: Run tests
        run: pnpm test

  # Job 5: Build platform-specific VSCode extensions
  build-vscode-extensions:
    name: Build VSCode Extensions
    needs: [build-native]
    runs-on: ubuntu-latest

    strategy:
      matrix:
        platform: [win32-x64, darwin-x64, darwin-arm64, linux-x64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Download platform-specific binaries
      - name: Download platform binaries
        uses: actions/download-artifact@v4
        with:
          name: holoscript-${{ matrix.platform }}
          path: packages/vscode-extension/bin/${{ matrix.platform }}

      - name: Install vsce
        run: pnpm add -g @vscode/vsce

      # Package platform-specific VSIX (P.002.01)
      - name: Package VSIX for ${{ matrix.platform }}
        run: vsce package --target ${{ matrix.platform }} -o holoscript-${{ matrix.platform }}.vsix
        working-directory: packages/vscode-extension

      - name: Upload VSIX
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension-${{ matrix.platform }}
          path: packages/vscode-extension/*.vsix
          retention-days: 7

  # Job 6: Publish to npm (AFTER Cargo)
  publish-npm:
    name: Publish to npm
    needs: [publish-cargo, test-multi-platform]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Download WASM packages
        uses: actions/download-artifact@v4
        with:
          name: wasm-packages

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      # Publish scoped packages
      - name: Publish @holoscript/* packages
        run: pnpm -r publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Job 7: Publish VSCode extensions
  publish-vscode:
    name: Publish VSCode Extensions
    needs: [build-vscode-extensions]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Download all VSIX files
        uses: actions/download-artifact@v4
        with:
          pattern: vscode-extension-*
          path: vsix-packages

      - name: Install vsce
        run: npm install -g @vscode/vsce

      # Publish all platform-specific VSIXs
      - name: Publish to VSCode Marketplace
        run: |
          for vsix in vsix-packages/**/*.vsix; do
            vsce publish --packagePath "$vsix" --pat ${{ secrets.VSCE_PAT }}
          done

  # Job 8: Create GitHub Release with binaries
  create-release:
    name: Create GitHub Release
    needs: [build-native, build-wasm, build-vscode-extensions]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release-artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
