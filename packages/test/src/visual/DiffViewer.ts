/**
 * Visual Diff Web UI - Sprint 2 Priority 8
 *
 * Web-based viewer for semantic diff results.
 * Generates an interactive HTML report showing:
 * - Side-by-side code comparison
 * - Highlighted changes
 * - Collapsible sections
 * - Summary statistics
 */

import * as fs from 'fs';
import * as path from 'path';

// =============================================================================
// TYPES
// =============================================================================

export interface DiffChange {
  type: 'added' | 'removed' | 'modified' | 'renamed' | 'moved' | 'unchanged';
  path: string;
  oldValue?: unknown;
  newValue?: unknown;
  oldName?: string;
  newName?: string;
  oldLine?: number;
  newLine?: number;
  description: string;
}

export interface SemanticDiffResult {
  equivalent: boolean;
  changeCount: number;
  changes: DiffChange[];
  summary: Record<string, number>;
  files: { old: string; new: string };
}

export interface DiffViewerOptions {
  /** Output directory for HTML report */
  outputDir: string;
  /** Include inline source code */
  includeSource: boolean;
  /** Theme: 'light' | 'dark' | 'auto' */
  theme: 'light' | 'dark' | 'auto';
  /** Report title */
  title: string;
}

const DEFAULT_OPTIONS: DiffViewerOptions = {
  outputDir: './diff-report',
  includeSource: true,
  theme: 'auto',
  title: 'HoloScript Semantic Diff',
};

// =============================================================================
// DIFF VIEWER
// =============================================================================

export class DiffViewer {
  private options: DiffViewerOptions;

  constructor(options: Partial<DiffViewerOptions> = {}) {
    this.options = { ...DEFAULT_OPTIONS, ...options };
  }

  /**
   * Generate HTML report from diff result
   */
  generate(result: SemanticDiffResult, oldSource?: string, newSource?: string): string {
    const html = this.buildHTML(result, oldSource, newSource);
    return html;
  }

  /**
   * Generate and save HTML report
   */
  save(
    result: SemanticDiffResult,
    outputPath?: string,
    oldSource?: string,
    newSource?: string
  ): void {
    const html = this.generate(result, oldSource, newSource);
    const outPath = outputPath || path.join(this.options.outputDir, 'diff-report.html');

    fs.mkdirSync(path.dirname(outPath), { recursive: true });
    fs.writeFileSync(outPath, html);
  }

  /**
   * Build complete HTML document
   */
  private buildHTML(result: SemanticDiffResult, oldSource?: string, newSource?: string): string {
    const styles = this.getStyles();
    const script = this.getScript();
    const summary = this.buildSummary(result);
    const changesList = this.buildChangesList(result.changes);
    const sideBySide =
      this.options.includeSource && oldSource && newSource
        ? this.buildSideBySide(oldSource, newSource, result.changes)
        : '';

    return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${this.escapeHtml(this.options.title)}</title>
  <style>${styles}</style>
</head>
<body class="theme-${this.options.theme}">
  <header>
    <h1>üîç ${this.escapeHtml(this.options.title)}</h1>
    <div class="file-info">
      <span class="old-file">üìÑ ${this.escapeHtml(result.files.old)}</span>
      <span class="arrow">‚Üî</span>
      <span class="new-file">üìÑ ${this.escapeHtml(result.files.new)}</span>
    </div>
  </header>

  <main>
    ${summary}

    <section class="changes-section">
      <h2>üìã Changes</h2>
      ${changesList}
    </section>

    ${
      sideBySide
        ? `
    <section class="source-section">
      <h2>üìù Side-by-Side Comparison</h2>
      ${sideBySide}
    </section>
    `
        : ''
    }
  </main>

  <footer>
    <p>Generated by HoloScript Visual Diff ‚Ä¢ ${new Date().toISOString()}</p>
  </footer>

  <script>${script}</script>
</body>
</html>`;
  }

  /**
   * Build summary section
   */
  private buildSummary(result: SemanticDiffResult): string {
    const stats = [
      { type: 'added', icon: '‚ûï', color: '#22c55e' },
      { type: 'removed', icon: '‚ûñ', color: '#ef4444' },
      { type: 'modified', icon: 'üìù', color: '#f59e0b' },
      { type: 'renamed', icon: 'üîÑ', color: '#3b82f6' },
      { type: 'moved', icon: 'üì¶', color: '#8b5cf6' },
    ];

    const statCards = stats
      .filter((s) => result.summary[s.type] > 0)
      .map(
        (s) => `
        <div class="stat-card" style="--card-color: ${s.color}">
          <span class="icon">${s.icon}</span>
          <span class="count">${result.summary[s.type]}</span>
          <span class="label">${s.type}</span>
        </div>
      `
      )
      .join('');

    return `
    <section class="summary-section">
      <div class="status ${result.equivalent ? 'equivalent' : 'different'}">
        ${
          result.equivalent
            ? '‚úÖ Files are semantically equivalent'
            : `‚ö†Ô∏è Found ${result.changeCount} semantic change(s)`
        }
      </div>
      <div class="stat-cards">
        ${statCards || '<div class="no-changes">No changes detected</div>'}
      </div>
    </section>
    `;
  }

  /**
   * Build changes list
   */
  private buildChangesList(changes: DiffChange[]): string {
    if (changes.length === 0) {
      return '<p class="no-changes">No changes to display.</p>';
    }

    const grouped = this.groupChangesByType(changes);
    const sections = Object.entries(grouped)
      .map(([type, typeChanges]) => {
        const items = typeChanges
          .map(
            (c) => `
          <li class="change-item change-${c.type}">
            <span class="change-path">${this.escapeHtml(c.path)}</span>
            ${c.oldLine ? `<span class="line-num">:${c.oldLine}</span>` : ''}
            <span class="change-desc">${this.escapeHtml(c.description)}</span>
            ${
              c.oldValue !== undefined || c.newValue !== undefined
                ? `
              <div class="change-values">
                ${c.oldValue !== undefined ? `<div class="old-value">- ${this.formatValue(c.oldValue)}</div>` : ''}
                ${c.newValue !== undefined ? `<div class="new-value">+ ${this.formatValue(c.newValue)}</div>` : ''}
              </div>
            `
                : ''
            }
          </li>
        `
          )
          .join('');

        return `
          <div class="change-group" data-type="${type}">
            <h3 class="group-header" onclick="toggleGroup(this)">
              <span class="chevron">‚ñº</span>
              ${this.getTypeLabel(type)} (${typeChanges.length})
            </h3>
            <ul class="change-list">${items}</ul>
          </div>
        `;
      })
      .join('');

    return `<div class="changes-container">${sections}</div>`;
  }

  /**
   * Build side-by-side source comparison
   */
  private buildSideBySide(oldSource: string, newSource: string, changes: DiffChange[]): string {
    const oldLines = oldSource.split('\n');
    const newLines = newSource.split('\n');

    const modifiedLines = new Set<number>();
    const addedLines = new Set<number>();
    const removedLines = new Set<number>();

    for (const change of changes) {
      if (change.type === 'added' && change.newLine) {
        addedLines.add(change.newLine);
      } else if (change.type === 'removed' && change.oldLine) {
        removedLines.add(change.oldLine);
      } else if (change.type === 'modified') {
        if (change.oldLine) modifiedLines.add(change.oldLine);
        if (change.newLine) modifiedLines.add(change.newLine);
      }
    }

    const maxLines = Math.max(oldLines.length, newLines.length);
    const rows: string[] = [];

    for (let i = 0; i < maxLines; i++) {
      const lineNum = i + 1;
      const oldLine = oldLines[i] ?? '';
      const newLine = newLines[i] ?? '';

      let oldClass = '';
      let newClass = '';

      if (removedLines.has(lineNum)) oldClass = 'line-removed';
      if (addedLines.has(lineNum)) newClass = 'line-added';
      if (modifiedLines.has(lineNum)) {
        oldClass = 'line-modified';
        newClass = 'line-modified';
      }

      rows.push(`
        <tr>
          <td class="line-num">${lineNum}</td>
          <td class="line-content ${oldClass}">${this.escapeHtml(oldLine) || '&nbsp;'}</td>
          <td class="line-num">${lineNum}</td>
          <td class="line-content ${newClass}">${this.escapeHtml(newLine) || '&nbsp;'}</td>
        </tr>
      `);
    }

    return `
      <div class="side-by-side">
        <table>
          <thead>
            <tr>
              <th colspan="2" class="old-header">${this.escapeHtml(path.basename(this.options.title))} (old)</th>
              <th colspan="2" class="new-header">${this.escapeHtml(path.basename(this.options.title))} (new)</th>
            </tr>
          </thead>
          <tbody>
            ${rows.join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  /**
   * Group changes by type
   */
  private groupChangesByType(changes: DiffChange[]): Record<string, DiffChange[]> {
    const grouped: Record<string, DiffChange[]> = {};
    for (const change of changes) {
      if (!grouped[change.type]) {
        grouped[change.type] = [];
      }
      grouped[change.type].push(change);
    }
    return grouped;
  }

  /**
   * Get type label with icon
   */
  private getTypeLabel(type: string): string {
    const labels: Record<string, string> = {
      added: '‚ûï Added',
      removed: '‚ûñ Removed',
      modified: 'üìù Modified',
      renamed: 'üîÑ Renamed',
      moved: 'üì¶ Moved',
    };
    return labels[type] || type;
  }

  /**
   * Format value for display
   */
  private formatValue(value: unknown): string {
    if (typeof value === 'string') return `"${this.escapeHtml(value)}"`;
    if (typeof value === 'object') {
      try {
        return `<code>${this.escapeHtml(JSON.stringify(value, null, 2))}</code>`;
      } catch {
        return '<code>[Object]</code>';
      }
    }
    return String(value);
  }

  /**
   * Escape HTML special characters
   */
  private escapeHtml(str: string): string {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  /**
   * Get CSS styles
   */
  private getStyles(): string {
    return `
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --border-color: #e2e8f0;
        --added-bg: #dcfce7;
        --added-text: #166534;
        --removed-bg: #fee2e2;
        --removed-text: #991b1b;
        --modified-bg: #fef3c7;
        --modified-text: #92400e;
      }

      .theme-dark, @media (prefers-color-scheme: dark) {
        .theme-auto {
          --bg-primary: #0f172a;
          --bg-secondary: #1e293b;
          --bg-tertiary: #334155;
          --text-primary: #f8fafc;
          --text-secondary: #94a3b8;
          --border-color: #334155;
          --added-bg: #14532d;
          --added-text: #86efac;
          --removed-bg: #7f1d1d;
          --removed-text: #fca5a5;
          --modified-bg: #78350f;
          --modified-text: #fcd34d;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        line-height: 1.6;
      }

      header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
      }

      header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .arrow {
        font-weight: bold;
      }

      main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      section {
        margin-bottom: 2rem;
      }

      h2 {
        font-size: 1.25rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .summary-section .status {
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        font-weight: 500;
      }

      .status.equivalent {
        background: var(--added-bg);
        color: var(--added-text);
      }

      .status.different {
        background: var(--modified-bg);
        color: var(--modified-text);
      }

      .stat-cards {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-left: 4px solid var(--card-color);
        border-radius: 0.5rem;
        padding: 1rem;
        min-width: 100px;
        text-align: center;
      }

      .stat-card .icon {
        font-size: 1.5rem;
        display: block;
      }

      .stat-card .count {
        font-size: 2rem;
        font-weight: bold;
        display: block;
      }

      .stat-card .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      .change-group {
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        overflow: hidden;
      }

      .group-header {
        background: var(--bg-secondary);
        padding: 0.75rem 1rem;
        margin: 0;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .group-header:hover {
        background: var(--bg-tertiary);
      }

      .chevron {
        transition: transform 0.2s;
      }

      .change-group.collapsed .chevron {
        transform: rotate(-90deg);
      }

      .change-group.collapsed .change-list {
        display: none;
      }

      .change-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .change-item {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-color);
      }

      .change-item.change-added {
        background: var(--added-bg);
      }

      .change-item.change-removed {
        background: var(--removed-bg);
      }

      .change-item.change-modified {
        background: var(--modified-bg);
      }

      .change-path {
        font-family: monospace;
        font-weight: 600;
      }

      .line-num {
        color: var(--text-secondary);
        font-size: 0.75rem;
      }

      .change-desc {
        display: block;
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      .change-values {
        margin-top: 0.5rem;
        font-family: monospace;
        font-size: 0.875rem;
      }

      .old-value {
        color: var(--removed-text);
      }

      .new-value {
        color: var(--added-text);
      }

      .side-by-side {
        overflow-x: auto;
      }

      .side-by-side table {
        width: 100%;
        border-collapse: collapse;
        font-family: monospace;
        font-size: 0.875rem;
      }

      .side-by-side th,
      .side-by-side td {
        border: 1px solid var(--border-color);
        padding: 0.25rem 0.5rem;
      }

      .side-by-side th {
        background: var(--bg-secondary);
        font-weight: 600;
      }

      .side-by-side .line-num {
        width: 3rem;
        text-align: right;
        background: var(--bg-tertiary);
        user-select: none;
      }

      .side-by-side .line-content {
        white-space: pre;
        min-width: 300px;
      }

      .line-added {
        background: var(--added-bg) !important;
      }

      .line-removed {
        background: var(--removed-bg) !important;
      }

      .line-modified {
        background: var(--modified-bg) !important;
      }

      .old-header {
        background: var(--removed-bg) !important;
        color: var(--removed-text);
      }

      .new-header {
        background: var(--added-bg) !important;
        color: var(--added-text);
      }

      footer {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        font-size: 0.75rem;
        border-top: 1px solid var(--border-color);
      }

      .no-changes {
        color: var(--text-secondary);
        font-style: italic;
        padding: 1rem;
      }

      code {
        background: var(--bg-tertiary);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
      }
    `;
  }

  /**
   * Get JavaScript for interactivity
   */
  private getScript(): string {
    return `
      function toggleGroup(header) {
        const group = header.closest('.change-group');
        group.classList.toggle('collapsed');
      }
    `;
  }
}

// =============================================================================
// CONVENIENCE FUNCTIONS
// =============================================================================

/**
 * Create diff viewer with default options
 */
export function createDiffViewer(options?: Partial<DiffViewerOptions>): DiffViewer {
  return new DiffViewer(options);
}

/**
 * Generate and save HTML diff report
 */
export function generateDiffReport(
  result: SemanticDiffResult,
  outputPath: string,
  oldSource?: string,
  newSource?: string,
  options?: Partial<DiffViewerOptions>
): void {
  const viewer = new DiffViewer(options);
  viewer.save(result, outputPath, oldSource, newSource);
}
